# Fix image URL path: album 534881 and ___ prefix

**Date:** 2026-01-25

## Problem

Album 534881 (and others with empty photo titles) had image URLs that 404 because the backend emitted `urlPath` and `highlightImageUrl` with a `___` prefix in the filename (e.g. `___20090418-img_1720.jpg`). Exported/served files are named without `___` (e.g. `20090418-img_1720.jpg`), so emitted paths did not match the real asset layout.

## Root cause

In `backend/legacyPaths.ts`, `getLinkTarget(uipathcomponent, pathcomponent)` and `getThumbTarget(...)` produced `uipathcomponent + '___' + pathcomponent` when the two differed (e.g. empty title → uipathcomponent `''` → filename `___20090418-img_1720.jpg`). The export pipeline writes pathcomponent-based filenames only, so the `___` form never existed on disk.

## Solution (Option A)

Align emitted paths with actual exported filenames. When `uipathcomponent` is empty, emit the pathcomponent-only filename (normalized: lowercase, `.jpg.jpg` → `.jpg`), not `___` + pathcomponent. The `___` prefix is now used only when uipathcomponent is non-empty and differs from pathcomponent (and only if the export produces such filenames).

## Changes

- **backend/legacyPaths.ts**: Added `normalizeFilename()`. `getLinkTarget('', pathcomponent)` now returns `normalizeFilename(pathcomponent)`. `getThumbTarget('', pathcomponent, prefix)` returns `prefix + normalizeFilename(pathcomponent)`. Comment documents the convention.
- **backend/legacyPaths.test.ts**: Tests for empty uipathcomponent: `getLinkTarget('', '20090418-IMG_1720.jpg')` → `'20090418-img_1720.jpg'`, `getThumbTarget('', '20090418-IMG_1720.jpg', 't__')` → `'t__20090418-img_1720.jpg'`.
- **backend/index.ts**: No signature or call-site changes; urlPath/highlightImageUrl/thumbnailUrlPath construction unchanged (dir from uipath, filename from getLinkTarget/getThumbTarget).

## Regenerate album JSON

After this backend change, album JSON for 534881 and any other affected albums (photos with empty title that previously got `___` in the filename) must be regenerated by re-running the backend extraction (e.g. the same config that produces `data/*.json`). Then `children[].urlPath`, `metadata.highlightImageUrl`, and album `thumbnailUrlPath` will no longer contain incorrect `___` filenames for the empty-uipath case.

## Frontend

No frontend code change: [frontend/src/utils/imageUrl.ts](frontend/src/utils/imageUrl.ts) uses `urlPath ?? pathComponent` as opaque paths. Once the backend emits correct paths, images load without modification.
